# doc_generator

> Reads a Ruby script, sends it to the Anthropic Claude API for analysis, and generates a GitHub Wiki Markdown page, a plain-text usage/help file, and a groff-formatted man page.

**Version:** 1.0.0  
**Generated:** 2026-02-20

---

## Purpose

It solves the problem of writing and maintaining documentation for Ruby command-line scripts by automating the process with AI. Instead of manually authoring Markdown docs, help text, and man pages, a developer can point this tool at any Ruby script and receive all three documentation artifacts in seconds, ensuring they stay consistent with the actual source code.

## Synopsis

```
doc_generator.rb [options] <script.rb>
```

## Description

The script parses CLI options with OptionParser, reads the target Ruby file, and constructs a detailed prompt instructing the Anthropic Claude API to return a structured JSON analysis of the script (options, examples, exit codes, etc.). It sends this prompt via Net::HTTP over TLS to the Anthropic Messages API, strips any accidental markdown fences from the response, and parses the resulting JSON. Three generator methods then transform the parsed JSON hash into Markdown (with tables and fenced code blocks), a fixed-width plain-text usage document, and a groff/troff man page with proper macros (.TH, .SH, .TP, .EX/.EE, .BR). All output files are written to a configurable directory using a slug derived from the target script's filename.

## Notable Qualities

The script is self-referential in nature — it uses an AI prompt that is structurally identical to the kind of documentation it generates, making it effectively able to document itself. It defensively strips markdown code fences from the API response despite explicitly requesting raw JSON, acknowledging the non-deterministic behavior of LLMs. The man page generator includes a regex-based heuristic to detect 'name(section)' patterns in see_also entries and convert them to proper .BR groff macros.

## Options

| Flag | Description |
|------|-------------|
| `-o, --output DIR` | Output directory for generated documentation files (default: current directory) |
| `-s, --section NUM` | Man page section number, 1-8 (default: 1) |
| `-a, --author NAME` | Author name for the man page header (default: $USER) |
| `-v, --verbose` | Print progress messages to stderr |
| `-V, --version` | Print version string and exit |
| `-h, --help` | Show help/usage information and exit |

## Usage Examples

```sh
doc_generator.rb my_script.rb
```

```sh
doc_generator.rb -o ./docs my_script.rb
```

```sh
doc_generator.rb -a 'Jane Doe' -s 1 -v cli_tool.rb
```

```sh
doc_generator.rb --output /usr/local/share/doc --section 8 admin_tool.rb
```

```sh
ANTHROPIC_API_KEY=sk-ant-... doc_generator.rb backup.rb
```

```sh
doc_generator.rb -o ./wiki -a 'Team Dev' -v json_store.rb
```

```sh
doc_generator.rb -s 6 daemon_config.rb && man ./daemon_config.6
```

## Environment Variables

| Variable | Description |
|----------|-------------|
| `ANTHROPIC_API_KEY` | Required. Your Anthropic API key used to authenticate requests to the Claude Messages API. |
| `USER` | Optional. Used as the default author name for the man page if --author is not specified. |

## Files

| Path | Description |
|------|-------------|
| `<script_name>.md` | Generated GitHub Wiki Markdown documentation page |
| `<script_name>_usage.txt` | Generated plain-text help/usage output suitable for --help |
| `<script_name>.<section>` | Generated groff/troff formatted man page (e.g. script.1) |

## Exit Codes

| Code | Meaning |
|------|---------|
| `0` | Success — all documentation files were generated and written |
| `1` | No script file specified, file not found, ANTHROPIC_API_KEY not set, invalid man section, API error, or JSON parse failure |

## Bugs / Limitations

The script defines a nested method `esc` inside `generate_man` using `def`, which in Ruby actually defines it at the enclosing scope rather than being lexically scoped — this could cause unexpected behavior if called elsewhere. The MAX_TOKENS limit of 4096 may be insufficient for very large or complex scripts, potentially causing truncated JSON responses. There is no retry logic or rate-limit handling for the API call. The word-wrap regex in `generate_usage` may break on very long unbreakable tokens. The version constant is hardcoded and not derived from the generated script.

## See Also

`ruby(1)`, `groff(1)`, `man(1)`, `curl(1)`, `jq(1)`, `OptionParser (Ruby stdlib)`, `pandoc(1)`

---

*Generated by [doc_generator.rb](doc_generator.rb)*
